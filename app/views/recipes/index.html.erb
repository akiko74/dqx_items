<% content_for :content do %>

  <%= form_for(Recipe.new, :method => :get, :html => { :class => "form-search", :onsubmit => 'add_recipes();return false;' }) do |f| %>
    <div class="input-append">
      <%= text_field_tag :recipes_keyword,
                         '',
                         :autocomplete  => "off", 
                         :placeholder   => "レシピ名を入力",
                         :class         => "span12 search-query",
                         :autofocus     => "autofocus",
                         "data-provide" => "typeahead"  %>
      <%= f.submit "検索", :class => "btn" %>
    </div>
  <% end %>

  <table id="recipe_list" class="table">
    <thead>
      <tr><th>レシピ名</th><th>店頭販売価格</th><th>アクション</th></tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <table id="item_list" class="table">
    <thead>
      <tr><th>アイテム名</th><th>合計必要数</th><th>購入金額（店売りのみ）</th></tr>
    </thead>
    <tbody>
    </tbody>
  </table>
<% end %>


<% content_for :head do %>
    <script>
      function get_recipe_list() {
        var _recipes = new Array();
        $.each( 
          $("#recipe_list tbody th"),
          function(key,val) {
            _recipes.push($(val).text());
          }
        );
        return _recipes;
      }
      function drow_recipe_list(recipe_list) {
        $("#recipe_list tbody").empty();
        for(var i in recipe_list) {
          $("#recipe_list tbody").append("<tr><th>" + recipe_list[i].name + "</th><td>" + recipe_list[i].price + "</td><td><a href=\"#\" onclick=\"javascript:drop_recipes(this)\" class=\"btn\">削除</a></td></tr>");
        }
      }
      function add_recipes() {
        var _recipes = get_recipe_list();
        _recipes.push($('#recipes_keyword').val());
        reload_items(_recipes);
        return false;
      }
      function drop_recipes(elm) {
        $(elm).parents('tr').remove();
        reload_items(get_recipe_list());
        return false;
      }
      function reload_items(recipes) {
        $.getJSON("/recipes.json", { recipes : recipes }, function(json){
          drow_recipe_list(json.recipe_list);
          drow_item_list(json.item_list);
        });
      }
      function drow_item_list(item_list) {
        $("#item_list tbody").empty();
        for(var i in item_list) {
          $("#item_list tbody").append("<tr><th>" + item_list[i].name + "</th><td>" + item_list[i].count + "</td></tr>");
        }
      }
    </script>
<% end %>

